set(donotmod_message "${donotmod_message}/***************************************************************************************************\n")
set(donotmod_message "${donotmod_message} * (!) This file has been automatically generated by CMake. DO NOT MODIFY!\n")
set(donotmod_message "${donotmod_message} **************************************************************************************************/\n")

function(add_test_subdirectory module)
    file(GLOB test_list "${module}/test_*.hpp")    # Find all test files (they must be named `test_*.hpp`)
    if(NOT test_list)
        message(STATUS "No unit tests found for module '${module}'.")
    else()
        # Convert the list of files into #includes:
        foreach(th ${test_list})
            set(test_list_includes "${test_list_includes}#include \"${th}\"\n")
        endforeach()
        set(test_header "#include \"test_${module}.hpp\"\n")          # Define the new header for this module.
        configure_file(test.hpp.in "${module}/test_${module}.hpp")    # Fill the placeholders.
        configure_file(test.cpp.in "${module}/test_${module}.cpp")    # Fill the placeholders.

        # Define the new test executable:
        add_executable(test_${module} ${module}/test_${module}.cpp)
        target_link_libraries(test_${module} ${module}_test ${ARGN})
        add_test(NAME ${module} COMMAND test_${module})
        set_target_properties(test_${module}
            PROPERTIES
            ARCHIVE_OUTPUT_DIRECTORY "${CMAKE_BINARY_DIR}/../lib"
            LIBRARY_OUTPUT_DIRECTORY "${CMAKE_BINARY_DIR}/../lib"
            RUNTIME_OUTPUT_DIRECTORY "${CMAKE_BINARY_DIR}/../bin"
            COMPILE_FLAGS            "${COVERAGE_CFLAGS}"
            LINK_FLAGS               "${COVERAGE_LDFLAGS}"
        )
        message(STATUS "Unit test created for '${module}' in '${module}/test_${module}.cpp'")
    endif()
endfunction(add_test_subdirectory)

# Add test subdirectories:
# -- NB: Prototype: add_test_subdirectory(<module_name> [<list_of_additional_module_dependencies>])
# --    Please note that module dependencies are normally required and configured in the module's
# --    CMakeLists.txt file. You "should not" provide additional dependencies unless they are
# --    external to the module itself.
# -- NOTE: folder/module names MUST match those in the sources.
add_test_subdirectory(common)
add_test_subdirectory(model     common_test scheduler_test graphics_test utils_test)
add_test_subdirectory(scheduler common_test model_test graphics_test)
